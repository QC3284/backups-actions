name: Repository Archive and Release

on:
  schedule:
    - cron: '0 4 * * *'  # æ¯å¤©ä¸­åˆ12ç‚¹è¿è¡Œä¸€æ¬¡
  workflow_dispatch:        # æ”¯æŒæ‰‹åŠ¨è§¦å‘

permissions:
  contents: write  # å…è®¸åˆ›å»º releases

jobs:
  archive-and-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository with full history
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–æ‰€æœ‰æäº¤å†å²

      - name: Setup archive tools
        run: |
          # å®‰è£… 7zip ç”¨äºé«˜æ•ˆå‹ç¼©å’Œåˆ†å·
          sudo apt-get update
          sudo apt-get install -y p7zip-full

      - name: Create archive filename
        id: archive-name
        run: |
          # ä½¿ç”¨æ—¥æœŸå’Œæäº¤å“ˆå¸Œç”Ÿæˆå”¯ä¸€æ–‡ä»¶å
          DATE=$(date -u +"%Y%m%d")
          SHORT_SHA=$(git rev-parse --short HEAD)
          echo "name=repo-archive-$DATE-$SHORT_SHA" >> $GITHUB_OUTPUT

      - name: Create archive
        id: create-archive
        run: |
          ARCHIVE_NAME="${{ steps.archive-name.outputs.name }}"
          
          # åˆ›å»ºä¸´æ—¶ç›®å½•å­˜æ”¾å½’æ¡£æ–‡ä»¶
          mkdir -p archive_temp
          
          # ä½¿ç”¨ 7zip åˆ›å»ºå‹ç¼©åŒ…ï¼ˆè¶…é«˜æ•ˆå‹ç¼©ï¼‰
          7z a -t7z -m0=lzma2 -mx=9 -mfb=64 -md=256m -ms -mmt \
            "archive_temp/$ARCHIVE_NAME.7z" . \
            -xr!.git \
            -xr!archive_temp
          
          # æ£€æŸ¥æ–‡ä»¶å¤§å°
          FILE_SIZE=$(stat -c %s "archive_temp/$ARCHIVE_NAME.7z")
          MAX_SIZE=1900000000  # 1.9GB
          
          if [ $FILE_SIZE -gt $MAX_SIZE ]; then
            echo "ğŸ“¦ Archive size: $(echo "scale=2; $FILE_SIZE/1000000000" | bc) GB - creating split archives"
            
            # åˆ é™¤åŸæ–‡ä»¶
            rm "archive_temp/$ARCHIVE_NAME.7z"
            
            # åˆ›å»ºåˆ†å·å‹ç¼© (æ¯å· 1.9GB)
            7z a -t7z -v1900m -m0=lzma2 -mx=9 -mfb=64 -md=256m -ms -mmt \
              "archive_temp/$ARCHIVE_NAME.7z" . \
              -xr!.git \
              -xr!archive_temp
              
            # è®¾ç½®åˆ†å·æ ‡å¿—
            echo "split=true" >> $GITHUB_OUTPUT
          else
            echo "ğŸ“¦ Archive size: $(echo "scale=2; $FILE_SIZE/1000000000" | bc) GB - single file"
            echo "split=false" >> $GITHUB_OUTPUT
          fi
          
          # åˆ—å‡ºåˆ›å»ºçš„å½’æ¡£æ–‡ä»¶
          echo "Generated archive files:"
          ls -lh archive_temp/

      - name: Create release
        uses: softprops/action-gh-release@v2
        with:
          name: "Repository Archive - ${{ steps.archive-name.outputs.name }}"
          tag_name: "archive/${{ steps.archive-name.outputs.name }}"
          body: |
            # ğŸ“¦ Repository Full Backup
            
            ## ğŸ” Archive Details
            - **Generated on**: ${{ steps.archive-name.outputs.name | slice(12,8) }}-${{ steps.archive-name.outputs.name | slice(20,2) }}-${{ steps.archive-name.outputs.name | slice(22,2) }}
            - **Commit SHA**: [${{ github.sha }}](https://github.com/${{ github.repository }}/commit/${{ github.sha }})
            - **Compression**: LZMA2 (Ultra)
            - **Archive Type**: 7z
            - **Split Archives**: ${{ steps.create-archive.outputs.split }}
            
            ## âš™ï¸ Restoration Guide
            ### Single File Archive:
            ```bash
            7z x ${{ steps.archive-name.outputs.name }}.7z
            ```
            
            ### Split Archives:
            ```bash
            7z x ${{ steps.archive-name.outputs.name }}.7z.001
            ```
            
            > ğŸ’¡ After extraction, run `git reset --hard` to restore repository state
            
            ---
            â±ï¸ Generated by [GitHub Actions](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) at $(date -u +'%Y-%m-%dT%H:%M:%SZ')
          files: |
            archive_temp/${{ steps.archive-name.outputs.name }}.7z*
          draft: false
          prerelease: false

      - name: Cleanup
        run: rm -rf archive_temp
