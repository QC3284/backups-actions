name: Repository Archive and Release

on:
  schedule:
    - cron: '0 0 */3 * *'  # 每3天运行一次
  workflow_dispatch:        # 支持手动触发

permissions:
  contents: write  # 允许创建 releases

jobs:
  archive-and-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository with full history
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # 获取所有提交历史

      - name: Setup archive tools
        run: |
          # 安装 7zip 用于高效压缩和分卷
          sudo apt-get update
          sudo apt-get install -y p7zip-full

      - name: Create archive filename
        id: archive-name
        run: |
          # 使用日期和提交哈希生成唯一文件名
          DATE=$(date -u +"%Y%m%d")
          SHORT_SHA=$(git rev-parse --short HEAD)
          echo "name=repo-archive-$DATE-$SHORT_SHA" >> $GITHUB_OUTPUT

      - name: Create archive
        id: create-archive
        run: |
          ARCHIVE_NAME="${{ steps.archive-name.outputs.name }}"
          
          # 创建临时目录存放归档文件
          mkdir -p archive_temp
          
          # 使用 7zip 创建压缩包（超高效压缩）
          7z a -t7z -m0=lzma2 -mx=9 -mfb=64 -md=256m -ms -mmt \
            "archive_temp/$ARCHIVE_NAME.7z" . \
            -xr!.git \
            -xr!archive_temp
          
          # 检查文件大小
          FILE_SIZE=$(stat -c %s "archive_temp/$ARCHIVE_NAME.7z")
          MAX_SIZE=1900000000  # 1.9GB
          
          if [ $FILE_SIZE -gt $MAX_SIZE ]; then
            echo "📦 Archive size: $(echo "scale=2; $FILE_SIZE/1000000000" | bc) GB - creating split archives"
            
            # 删除原文件
            rm "archive_temp/$ARCHIVE_NAME.7z"
            
            # 创建分卷压缩 (每卷 1.9GB)
            7z a -t7z -v1900m -m0=lzma2 -mx=9 -mfb=64 -md=256m -ms -mmt \
              "archive_temp/$ARCHIVE_NAME.7z" . \
              -xr!.git \
              -xr!archive_temp
              
            # 设置分卷标志
            echo "split=true" >> $GITHUB_OUTPUT
          else
            echo "📦 Archive size: $(echo "scale=2; $FILE_SIZE/1000000000" | bc) GB - single file"
            echo "split=false" >> $GITHUB_OUTPUT
          fi
          
          # 列出创建的归档文件
          echo "Generated archive files:"
          ls -lh archive_temp/

      - name: Create release
        uses: softprops/action-gh-release@v1
        with:
          name: "Repository Archive - ${{ steps.archive-name.outputs.name }}"
          tag_name: "archive/${{ steps.archive-name.outputs.name }}"
          body: |
            ### 📦 Full Repository Backup
            - Generated on: ${{ steps.archive-name.outputs.name }}
            - Commit: [$GITHUB_SHA](https://github.com/$GITHUB_REPOSITORY/commit/$GITHUB_SHA)
            - Contains full Git history and all files
            
            🔐 **Backup Details**
            - Compression: LZMA2 (Ultra)
            - Archive type: 7z
            - Split archives: ${{ steps.create-archive.outputs.split }}
            
            ℹ️ **Restoration Instructions**
            1. Download all archive parts
            2. Combine using: `7z x archive-name.7z.001`
            3. Run `git reset --hard` to restore state
            
            ⏱ Generated by GitHub Actions at $(date -u +'%Y-%m-%d %H:%M:%S UTC')
          files: |
            archive_temp/${{ steps.archive-name.outputs.name }}.7z*
          draft: false
          prerelease: false

      - name: Cleanup
        run: rm -rf archive_temp
