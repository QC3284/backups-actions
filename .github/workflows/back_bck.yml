name: Repository Archive and Release

on:
  schedule:
    - cron: '0 0 */3 * *'  # æ¯3å¤©è¿è¡Œä¸€æ¬¡
  workflow_dispatch:        # æ”¯æŒæ‰‹åŠ¨è§¦å‘

permissions:
  contents: write  # å…è®¸åˆ›å»º releases

jobs:
  archive-and-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository with full history
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–æ‰€æœ‰æäº¤å†å²

      - name: Setup archive tools
        run: |
          # å®‰è£… 7zip ç”¨äºé«˜æ•ˆå‹ç¼©å’Œåˆ†å·
          sudo apt-get update
          sudo apt-get install -y p7zip-full

      - name: Create archive filename
        id: archive-name
        run: |
          # ä½¿ç”¨æ—¥æœŸå’Œæäº¤å“ˆå¸Œç”Ÿæˆå”¯ä¸€æ–‡ä»¶å
          DATE=$(date -u +"%Y%m%d")
          SHORT_SHA=$(git rev-parse --short HEAD)
          echo "name=repo-archive-$DATE-$SHORT_SHA" >> $GITHUB_OUTPUT

      - name: Create archive
        id: create-archive
        run: |
          ARCHIVE_NAME="${{ steps.archive-name.outputs.name }}"
          
          # åˆ›å»ºä¸´æ—¶ç›®å½•å­˜æ”¾å½’æ¡£æ–‡ä»¶
          mkdir -p archive_temp
          
          # ä½¿ç”¨ 7zip åˆ›å»ºå‹ç¼©åŒ…ï¼ˆè¶…é«˜æ•ˆå‹ç¼©ï¼‰
          7z a -t7z -m0=lzma2 -mx=9 -mfb=64 -md=256m -ms -mmt \
            "archive_temp/$ARCHIVE_NAME.7z" . \
            -xr!.git \
            -xr!archive_temp
          
          # æ£€æŸ¥æ–‡ä»¶å¤§å°
          FILE_SIZE=$(stat -c %s "archive_temp/$ARCHIVE_NAME.7z")
          MAX_SIZE=1900000000  # 1.9GB
          
          if [ $FILE_SIZE -gt $MAX_SIZE ]; then
            echo "ğŸ“¦ Archive size: $(echo "scale=2; $FILE_SIZE/1000000000" | bc) GB - creating split archives"
            
            # åˆ é™¤åŸæ–‡ä»¶
            rm "archive_temp/$ARCHIVE_NAME.7z"
            
            # åˆ›å»ºåˆ†å·å‹ç¼© (æ¯å· 1.9GB)
            7z a -t7z -v1900m -m0=lzma2 -mx=9 -mfb=64 -md=256m -ms -mmt \
              "archive_temp/$ARCHIVE_NAME.7z" . \
              -xr!.git \
              -xr!archive_temp
              
            # è®¾ç½®åˆ†å·æ ‡å¿—
            echo "split=true" >> $GITHUB_OUTPUT
          else
            echo "ğŸ“¦ Archive size: $(echo "scale=2; $FILE_SIZE/1000000000" | bc) GB - single file"
            echo "split=false" >> $GITHUB_OUTPUT
          fi
          
          # åˆ—å‡ºåˆ›å»ºçš„å½’æ¡£æ–‡ä»¶
          echo "Generated archive files:"
          ls -lh archive_temp/

      - name: Create release
        uses: softprops/action-gh-release@v1
        with:
          name: "Repository Archive - ${{ steps.archive-name.outputs.name }}"
          tag_name: "archive/${{ steps.archive-name.outputs.name }}"
          body: |
            ### ğŸ“¦ Full Repository Backup
            - Generated on: ${{ steps.archive-name.outputs.name }}
            - Commit: [$GITHUB_SHA](https://github.com/$GITHUB_REPOSITORY/commit/$GITHUB_SHA)
            - Contains full Git history and all files
            
            ğŸ” **Backup Details**
            - Compression: LZMA2 (Ultra)
            - Archive type: 7z
            - Split archives: ${{ steps.create-archive.outputs.split }}
            
            â„¹ï¸ **Restoration Instructions**
            1. Download all archive parts
            2. Combine using: `7z x archive-name.7z.001`
            3. Run `git reset --hard` to restore state
            
            â± Generated by GitHub Actions at $(date -u +'%Y-%m-%d %H:%M:%S UTC')
          files: |
            archive_temp/${{ steps.archive-name.outputs.name }}.7z*
          draft: false
          prerelease: false

      - name: Cleanup
        run: rm -rf archive_temp
