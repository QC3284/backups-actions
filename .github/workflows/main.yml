name: Repository Backup and Release

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * *'

permissions:
  contents: write

jobs:
  backup-and-release:
    runs-on: ubuntu-latest
    steps:
      # åˆå§‹åŒ–ç¯å¢ƒ
      - name: Setup environment
        run: |
          mkdir -p backup_temp compressed_backups
          : > success.txt; : > failed.txt
          sudo apt-get update
          sudo apt-get install -y zstd

      # ç£ç›˜æ¸…ç†
      - name: Free Disk Space (Ubuntu)
        uses: jlumbroso/free-disk-space@main
        with:
          # this might remove tools that are actually needed,
          # if set to "true" but frees about 6 GB
          tool-cache: false
        
          # all of these default to true, but feel free to set to
          # "false" if necessary for your workflow
          android: true
          dotnet: true
          haskell: true
          large-packages: true
          docker-images: true
          swap-storage: true

      # åˆ›å»ºå‘å¸ƒ
      - name: Create release
        id: create_release
        run: |
          tag="backup-$(date +%Y%m%d%H%M%S)"
          gh release create $tag \
            --title "ğŸ“¦ Backups $(date -u +'%Y-%m-%d %H:%M:%S UTC')" \
            --notes "ğŸš§ Backup in progress..." \
            --draft
          echo "tag=$tag" >> $GITHUB_OUTPUT
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # æ ¸å¿ƒå¤‡ä»½æµç¨‹
      - name: Backup repositories
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAG: ${{ steps.create_release.outputs.tag }}
        run: |
          # å·¥å…·å‡½æ•°
          disk_space() { df -BM . | awk 'NR==2 {print $4}' | tr -d 'M'; }
          
          # å¤„ç†æ¯ä¸ªä»“åº“
          while read -r url; do
            [[ -z $url || $url == \#* ]] && continue
            echo "ğŸ“¦ Processing: $url"
            
            # è§£æURL
            if [[ $url =~ github.com[/:]([^/]+)/([^/.]+) ]]; then
              owner=${BASH_REMATCH[1]}
              repo=${BASH_REMATCH[2]%.git}
              dir="backup_temp/$owner-$repo"
              file="compressed_backups/$owner-$repo-$(date +%s).tar.zst"
              
              # ç£ç›˜æ£€æŸ¥ï¼ˆå¢åŠ äºŒæ¬¡æ£€æŸ¥ï¼‰
              space=$(disk_space)
              if [[ $space -lt 500 ]]; then
                for f in compressed_backups/*.tar.zst; do
                  gh release upload $TAG "$f" --clobber && rm -f "$f"
                done
                # ä¸Šä¼ åå†æ¬¡æ£€æŸ¥ç©ºé—´
                space=$(disk_space)
                [[ $space -lt 500 ]] && {
                  echo "$owner/$repo" >> failed.txt
                  echo "âš ï¸ Skipping due to low disk space"
                  continue
                }
              fi
              
              # å…‹éš†ä»“åº“ï¼ˆå¢åŠ è¶…æ—¶ï¼‰
              for i in {1..3}; do
                rm -rf "$dir"
                timeout 300 git clone --mirror "$url" "$dir" && break
                [[ $i -lt 3 ]] && sleep 10
              done || {
                echo "$owner/$repo" >> failed.txt
                echo "âŒ Clone failed after 3 attempts"
                continue
              }
              
              # å‹ç¼©ä»“åº“ï¼ˆå¢åŠ é”™è¯¯å¤„ç†ï¼‰
              if (cd "$dir" && tar cf - . | zstd -22 --ultra -T0 > "../$file"); then
                echo "$owner/$repo" >> success.txt
                # ç«‹å³æ¸…ç†å…‹éš†ç›®å½•
                rm -rf "$dir"
              else
                echo "$owner/$repo" >> failed.txt
                echo "âŒ Compression failed"
                rm -f "../$file"
                continue
              fi
              
              # ä¸Šä¼ å¤§æ–‡ä»¶ï¼ˆ>50MBï¼‰
              if [[ $(du -m "$file" | cut -f1) -gt 50 ]]; then
                gh release upload $TAG "$file" --clobber && rm -f "$file"
              fi
            else
              echo "$url" >> failed.txt
              echo "âŒ Invalid URL format"
            fi
          done < back_ck_url.txt

      # ä¸Šä¼ å‰©ä½™æ–‡ä»¶ï¼ˆå¢åŠ é”™è¯¯å¤„ç†ï¼‰
      - name: Upload remaining
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAG: ${{ steps.create_release.outputs.tag }}
        run: |
          for file in compressed_backups/*.tar.zst; do
            if ! gh release upload $TAG "$file" --clobber; then
              echo "âŒ Failed to upload ${file##*/}" >&2
            else
              rm -f "$file"
            fi
          done

      # ç”ŸæˆæŠ¥å‘Šï¼ˆä¿®å¤è®¡æ•°é€»è¾‘ï¼‰
      - name: Generate report
        id: report
        run: |
          success_count=$(wc -l < success.txt 2>/dev/null | tr -d ' ' || echo 0)
          failed_count=$(grep -cv '^$' failed.txt 2>/dev/null | tr -d ' ' || echo 0)
          
          report="## ğŸ“Š Backup Summary\n\n"
          report+="### âœ… Success ($success_count)\n"
          [[ $success_count -gt 0 ]] && \
            report+=$(awk '{print "| " $0 " |"}' success.txt) || \
            report+="No successful backups\n"
          
          report+="\n### âŒ Failed ($failed_count)\n"
          [[ $failed_count -gt 0 ]] && \
            report+="| Repository | Error |\n|------------|-------|\n$(awk '{print "| " $0 " | Backup failed |"}' failed.txt)" || \
            report+="No failed backups\n"
          
          # ç¼–ç è¾“å‡º
          report="${report//'%'/'%25'}"
          report="${report//$'\n'/'%0A'}"
          echo "report=$report" >> $GITHUB_OUTPUT
          echo "success=$success_count" >> $GITHUB_OUTPUT
          echo "failed=$failed_count" >> $GITHUB_OUTPUT

      # å‘å¸ƒæœ€ç»ˆç‰ˆæœ¬
      - name: Publish release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAG: ${{ steps.create_release.outputs.tag }}
          REPORT: ${{ steps.report.outputs.report }}
        run: |
          # è§£ç æŠ¥å‘Š
          body="${REPORT//'%0A'/$'\n'}"
          body="${body//'%25'/'%'}"
          
          # æ›´æ–°å¹¶å‘å¸ƒ
          gh release edit $TAG --notes "$body" --draft=false

      # çŠ¶æ€æ‘˜è¦ï¼ˆä¿®å¤è®¡æ•°æ˜¾ç¤ºï¼‰
      - name: Status summary
        run: |
          echo "## Backup Results" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Success: ${{ steps.report.outputs.success }}" >> $GITHUB_STEP_SUMMARY
          echo "- âŒ Failed: ${{ steps.report.outputs.failed }}" >> $GITHUB_STEP_SUMMARY
          url="https://github.com/$GITHUB_REPOSITORY/releases/tag/${{ steps.create_release.outputs.tag }}"
          echo "ğŸ“¦ [View Release]($url)" >> $GITHUB_STEP_SUMMARY
