name: Repository Backup Automation

on:
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘
  schedule:
    - cron: '0 0 * * *'  # æ¯å¤©UTCæ—¶é—´0ç‚¹è‡ªåŠ¨è¿è¡Œ

jobs:
  backup-repositories:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout current repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–æ‰€æœ‰å†å²è®°å½•

      - name: Setup Git User
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@users.noreply.github.com"

      - name: Backup repositories
        id: backup
        run: |
          # åˆ›å»ºå¤‡ä»½ç›®å½•
          mkdir -p backups
          
          # å¤„ç†æ¯ä¸ªä»“åº“URL
          while IFS= read -r repo_url; do
            # è·³è¿‡ç©ºè¡Œå’Œæ³¨é‡Š
            [[ -z "$repo_url" || "$repo_url" == \#* ]] && continue
            
            echo "ğŸ“¦ Processing: $repo_url"
            
            # ä»URLè§£æownerå’Œrepoåç§°
            if [[ $repo_url =~ github.com[/:]([^/]+)/([^/.]+) ]]; then
              owner="${BASH_REMATCH[1]}"
              repo="${BASH_REMATCH[2]%.git}"  # ç§»é™¤.gitåç¼€
              backup_dir="backups/$owner/$repo"
              
              # åˆ›å»ºå¤‡ä»½ç›®å½•
              mkdir -p "$backup_dir"
              
              # å¤‡ä»½é€»è¾‘
              if [ -d "$backup_dir" ] && [ -f "$backup_dir/HEAD" ]; then
                echo "ğŸ”„ Updating existing backup..."
                (
                  cd "$backup_dir"
                  git fetch --all --force --tags 2>&1 | sed 's/^/    /'
                )
                status=$?
              else
                echo "âœ¨ Creating new backup..."
                git clone --mirror "$repo_url" "$backup_dir" 2>&1 | sed 's/^/    /'
                status=$?
              fi
              
              # å¤„ç†å¤‡ä»½ç»“æœ
              if [ $status -eq 0 ]; then
                echo "âœ… Success: $repo_url"
                echo "owner=$owner" >> $GITHUB_OUTPUT
                echo "repo=$repo" >> $GITHUB_OUTPUT
              else
                echo "âŒ Backup failed for $repo_url, keeping old version"
                # æ¢å¤å¯èƒ½è¢«ä¿®æ”¹çš„æ–‡ä»¶
                git restore "$backup_dir" || true
              fi
            else
              echo "âš ï¸ Invalid URL: $repo_url"
            fi
            echo "--------------------------------------------------"
          done < back_ck_url.txt

      - name: Commit changes
        if: success()
        run: |
          # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´
          if git diff-index --quiet HEAD --; then
            echo "ğŸŸ¢ No changes detected"
          else
            # æ·»åŠ æ‰€æœ‰å¤‡ä»½æ–‡ä»¶
            git add backups/
            
            # ç”Ÿæˆæäº¤ä¿¡æ¯
            commit_msg="ğŸ“¤ Backup update: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
            
            # æ·»åŠ æˆåŠŸå¤‡ä»½çš„ä»“åº“
            echo "${{ steps.backup.outputs.owner }}" | while read -r owner; do
              if [ -n "$owner" ]; then
                commit_msg="$commit_msg"$'\n'"â€¢ $owner/${{ steps.backup.outputs.repo }}"
              fi
            done
            
            # æäº¤å˜æ›´
            git commit -m "$commit_msg"
            git push
            echo "ğŸš€ Changes committed and pushed"
          fi
