name: Repository Backup and Release

on:
  workflow_dispatch:
  schedule:
    - cron: '0 4 * * *'

permissions:
  contents: write

jobs:
  backup-and-release:
    runs-on: ubuntu-latest
    steps:
      # åˆå§‹åŒ–ç¯å¢ƒ
      - name: Setup environment
        run: |
          sudo apt-get update
          sudo apt-get install -y zstd pv jq curl
          mkdir -p backup_temp compressed_backups
          echo "WORKSPACE=$(pwd)" >> $GITHUB_ENV
          : > success.txt; : > failed.txt

      - name: Free Disk Space (Ubuntu)
        uses: jlumbroso/free-disk-space@main
        with:
          # this might remove tools that are actually needed,
          # if set to "true" but frees about 6 GB
          tool-cache: false
        
          # all of these default to true, but feel free to set to
          # "false" if necessary for your workflow
          android: true
          dotnet: true
          haskell: true
          large-packages: true
          docker-images: true
          swap-storage: true
     
     # ä¸‹è½½ä»“åº“åˆ—è¡¨æ–‡ä»¶
      - name: Download repository list
        run: |
          # ç›´æ¥ä»å½“å‰ä»“åº“ä¸‹è½½ back_ck_url.txt æ–‡ä»¶
          curl -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3.raw" \
            -o back_ck_url.txt \
            "https://api.github.com/repos/${{ github.repository }}/contents/back_ck_url.txt"
          
          # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
          if [ ! -f back_ck_url.txt ]; then
            echo "âŒ back_ck_url.txt æ–‡ä»¶ä¸å­˜åœ¨æˆ–ä¸‹è½½å¤±è´¥"
            exit 1
          fi
          
          echo "ğŸ“‹ ä»“åº“åˆ—è¡¨:"
          cat back_ck_url.txt

      # åˆ›å»ºå‘å¸ƒ - ä¿®å¤ç‰ˆæœ¬
      - name: Create release
        id: create_release
        run: |
          # åˆå§‹åŒ–ä¸€ä¸ªä¸´æ—¶ Git ä»“åº“ç”¨äº gh å‘½ä»¤
          git init temp_repo
          cd temp_repo
          git config user.email "action@github.com"
          git config user.name "GitHub Action"
          
          tag="backup-$(date +%Y%m%d%H%M%S)"
          gh release create $tag \
            --title "ğŸ“¦ Backups $(date -u +'%Y-%m-%d %H:%M:%S UTC')" \
            --notes "ğŸš§ Backup in progress..." \
            --draft
          echo "tag=$tag" >> $GITHUB_OUTPUT
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # æ ¸å¿ƒå¤‡ä»½æµç¨‹
      - name: Backup repositories
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAG: ${{ steps.create_release.outputs.tag }}
        run: |
          # å·¥å…·å‡½æ•°
          disk_space() { df -BM . | awk 'NR==2 {print $4}' | tr -d 'M'; }
          check_disk_space() {
            local required=$1
            local space=$(disk_space)
            if [[ $space -lt $required ]]; then
              echo "âš ï¸ ä½ç£ç›˜ç©ºé—´: ${space}MB < ${required}MB"
              # å°è¯•ä¸Šä¼ ç°æœ‰æ–‡ä»¶é‡Šæ”¾ç©ºé—´
              for f in compressed_backups/*; do
                [[ -f "$f" ]] && gh release upload $TAG "$f" --clobber && rm -f "$f" && echo "ğŸ“¤ å·²ä¸Šä¼ å¹¶åˆ é™¤: $f"
              done
              # é‡æ–°æ£€æŸ¥
              space=$(disk_space)
              if [[ $space -lt $required ]]; then
                echo "âŒ ç£ç›˜ç©ºé—´ä¸è¶³ï¼Œæ— æ³•ç»§ç»­"
                return 1
              fi
            fi
            return 0
          }
          
          # åˆå§‹ç£ç›˜ç©ºé—´æ£€æŸ¥
          if ! check_disk_space 5000; then
            echo "âŒ åˆå§‹ç£ç›˜ç©ºé—´ä¸è¶³"
            exit 1
          fi
          
          # å¤„ç†æ¯ä¸ªä»“åº“
          while read -r url; do
            [[ -z $url || $url == \#* ]] && continue
            echo "ğŸ“¦ Processing: $url"
            
            # è§£æURL
            if [[ $url =~ github.com[/:]([^/]+)/([^/.]+) ]]; then
              owner=${BASH_REMATCH[1]}
              repo=${BASH_REMATCH[2]%.git}
              dir="backup_temp/$owner-$repo"
              file="compressed_backups/$owner-$repo-$(date +%s).tar.zst"
              
              # ç£ç›˜æ£€æŸ¥
              if ! check_disk_space 2000; then
                echo "$owner/$repo" >> failed.txt
                echo "âŒ ç£ç›˜ç©ºé—´ä¸è¶³ï¼Œè·³è¿‡ä»“åº“"
                continue
              fi
              
              # å…‹éš†ä»“åº“ (å¸¦è¿›åº¦æ˜¾ç¤ºå’Œé‡è¯•æœºåˆ¶)
              max_retries=3
              retry_count=0
              clone_success=false
              
              while [[ $retry_count -lt $max_retries && $clone_success == false ]]; do
                retry_count=$((retry_count+1))
                echo "ğŸ”„ å…‹éš†ä»“åº“ (å°è¯• $retry_count/$max_retries)..."
                rm -rf "$dir" 2>/dev/null || true
                
                if timeout 600 git clone --mirror "$url" "$dir" 2>&1 | tee clone.log; then
                  clone_success=true
                  echo "âœ… å…‹éš†æˆåŠŸ"
                else
                  echo "âŒ å…‹éš†å¤±è´¥ï¼Œç­‰å¾…é‡è¯•..."
                  sleep $((retry_count * 5))
                fi
              done
              
              if [[ $clone_success == false ]]; then
                echo "$owner/$repo" >> failed.txt
                echo "âŒ å…‹éš†å¤±è´¥ï¼Œè·³è¿‡ä»“åº“"
                continue
              fi
              
              # æ£€æŸ¥å…‹éš†å¤§å°
              repo_size=$(du -sm "$dir" | cut -f1)
              echo "ğŸ“Š ä»“åº“å¤§å°: ${repo_size}MB"
              
              # ç£ç›˜ç©ºé—´äºŒæ¬¡æ£€æŸ¥ (è€ƒè™‘å‹ç¼©æ‰€éœ€ç©ºé—´)
              required_space=$((repo_size * 2 + 100)) # é¢å¤–100MBç¼“å†²
              if ! check_disk_space $required_space; then
                echo "$owner/$repo" >> failed.txt
                echo "âŒ å‹ç¼©ç©ºé—´ä¸è¶³ï¼Œè·³è¿‡"
                rm -rf "$dir"
                continue
              fi
              
              # å‹ç¼©ä»“åº“ (ä½¿ç”¨pvæ˜¾ç¤ºè¿›åº¦)
              echo "ğŸ—œï¸ å‹ç¼©ä»“åº“..."
              mkdir -p compressed_backups
              if (cd "$dir" && tar cf - . | pv -s ${repo_size}m | zstd -10 -T0 > "${WORKSPACE}/$file"); then
                echo "$owner/$repo" >> success.txt
                rm -rf "$dir"
                
                # æ£€æŸ¥å‹ç¼©æ–‡ä»¶
                if [[ ! -f "${WORKSPACE}/$file" ]]; then
                  echo "âŒ å‹ç¼©æ–‡ä»¶æœªåˆ›å»º"
                  echo "$owner/$repo" >> failed.txt
                  continue
                fi
                
                # æ–‡ä»¶å¤§å°æ£€æŸ¥
                file_size=$(du -m "${WORKSPACE}/$file" | cut -f1)
                
                # åˆ†å·å‹ç¼©é€»è¾‘ï¼ˆè¶…è¿‡1.8GBæ—¶ï¼‰
                if [[ $file_size -gt 1800 ]]; then
                  echo "âœ‚ï¸ æ–‡ä»¶è¿‡å¤§ (${file_size}MB)ï¼Œè¿›è¡Œåˆ†å·å¤„ç†..."
                  
                  # åˆ†å·è®¾ç½®ï¼ˆæ¯ä¸ªåˆ†å·1.8GBï¼‰
                  split -b 1800M -d -a 3 "${WORKSPACE}/$file" "${WORKSPACE}/$file.part"
                  
                  # ä¸Šä¼ åˆ†å·æ–‡ä»¶
                  for part_file in "${WORKSPACE}/$file.part"*; do
                    echo "â¬†ï¸ ä¸Šä¼ åˆ†å·: $(basename "$part_file")"
                    if gh release upload $TAG "$part_file" --clobber; then
                      rm -f "$part_file"
                    else
                      echo "âš ï¸ åˆ†å·ä¸Šä¼ å¤±è´¥ï¼Œä¿ç•™æ–‡ä»¶ç¨åä¸Šä¼ "
                    fi
                  done
                  
                  # åˆ é™¤åŸå§‹å¤§æ–‡ä»¶
                  rm -f "${WORKSPACE}/$file"
                else
                  # æ™®é€šæ–‡ä»¶ä¸Šä¼ 
                  echo "â¬†ï¸ ä¸Šä¼ æ–‡ä»¶ (${file_size}MB)..."
                  if gh release upload $TAG "${WORKSPACE}/$file" --clobber; then
                    rm -f "${WORKSPACE}/$file"
                  else
                    echo "âš ï¸ ä¸Šä¼ å¤±è´¥ï¼Œä¿ç•™æ–‡ä»¶ç¨åä¸Šä¼ "
                  fi
                fi
              else
                echo "$owner/$repo" >> failed.txt
                echo "âŒ å‹ç¼©å¤±è´¥"
                [[ -f "${WORKSPACE}/$file" ]] && rm -f "${WORKSPACE}/$file"
                rm -rf "$dir"
              fi
            else
              echo "$url" >> failed.txt
              echo "âŒ æ— æ•ˆURLæ ¼å¼"
            fi
          done < back_ck_url.txt

      # ä¸Šä¼ å‰©ä½™æ–‡ä»¶
      - name: Upload remaining
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAG: ${{ steps.create_release.outputs.tag }}
        run: |
          max_retries=3
          for file in compressed_backups/*; do
            if [[ -f "$file" ]]; then
              echo "â¬†ï¸ ä¸Šä¼ å‰©ä½™æ–‡ä»¶: $(basename "$file")"
              retry_count=0
              uploaded=false
              
              while [[ $retry_count -lt $max_retries && $uploaded == false ]]; do
                if gh release upload $TAG "$file" --clobber; then
                  rm -f "$file"
                  uploaded=true
                  echo "âœ… ä¸Šä¼ æˆåŠŸ"
                else
                  retry_count=$((retry_count+1))
                  echo "âŒ ä¸Šä¼ å¤±è´¥ï¼Œé‡è¯• $retry_count/$max_retries"
                  sleep 5
                fi
              done
              
              if [[ $uploaded == false ]]; then
                echo "âŒ æœ€ç»ˆä¸Šä¼ å¤±è´¥: $(basename "$file")"
              fi
            fi
          done

      # ç”ŸæˆæŠ¥å‘Š
      - name: Generate report
        id: report
        run: |
          # ç¡®ä¿æ–‡ä»¶å­˜åœ¨
          touch success.txt failed.txt
          
          # è·å–è®¡æ•°
          success_count=$(wc -l < success.txt | tr -d ' ' || echo 0)
          failed_count=$(wc -l < failed.txt | tr -d ' ' || echo 0)
          total=$((success_count + failed_count))
          
          # åˆ›å»ºç®€æ´æŠ¥å‘Š
          report="# ğŸ“Š Backup Summary\n\n"
          report+="## âœ… Successfully Backed Up ($success_count)\n"
          if [[ $success_count -gt 0 ]]; then
            report+="\`\`\`\n"
            report+=$(cat success.txt)
            report+="\n\`\`\`\n"
          else
            report+="> No repositories backed up successfully\n"
          fi
          
          report+="\n## âŒ Failed to Backup ($failed_count)\n"
          if [[ $failed_count -gt 0 ]]; then
            report+="\`\`\`\n"
            report+=$(cat failed.txt)
            report+="\n\`\`\`\n"
          else
            report+="> All repositories backed up successfully!\n"
          fi
          
          report+="\n---\n"
          report+="â±ï¸ Generated at $(date -u +'%Y-%m-%d %H:%M:%S UTC')\n"
          report+="â„¹ï¸ Total repositories: $total"
          
          # ç¼–ç è¾“å‡º
          report="${report//'%'/'%25'}"
          report="${report//$'\n'/'%0A'}"
          echo "report=$report" >> $GITHUB_OUTPUT
          echo "success=$success_count" >> $GITHUB_OUTPUT
          echo "failed=$failed_count" >> $GITHUB_OUTPUT

      # å‘å¸ƒæœ€ç»ˆç‰ˆæœ¬
      - name: Publish release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAG: ${{ steps.create_release.outputs.tag }}
          REPORT: ${{ steps.report.outputs.report }}
        run: |
          # åˆå§‹åŒ–ä¸€ä¸ªä¸´æ—¶ Git ä»“åº“ç”¨äº gh å‘½ä»¤
          git init temp_repo
          cd temp_repo
          git config user.email "action@github.com"
          git config user.name "GitHub Action"
          
          body="${REPORT//'%0A'/$'\n'}"
          body="${body//'%25'/'%'}"
          gh release edit $TAG --notes "$body" --draft=false

      # çŠ¶æ€æ‘˜è¦
      - name: Status summary
        run: |
          echo "## å¤‡ä»½ç»“æœ" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… æˆåŠŸ: ${{ steps.report.outputs.success }}" >> $GITHUB_STEP_SUMMARY
          echo "- âŒ å¤±è´¥: ${{ steps.report.outputs.failed }}" >> $GITHUB_STEP_SUMMARY
          url="https://github.com/$GITHUB_REPOSITORY/releases/tag/${{ steps.create_release.outputs.tag }}"
          echo "ğŸ“¦ [æŸ¥çœ‹å‘å¸ƒ]($url)" >> $GITHUB_STEP_SUMMARY
          
      # æ¸…ç†å·¥ä½œåŒº
      - name: Cleanup workspace
        run: |
          rm -rf backup_temp compressed_backups success.txt failed.txt back_ck_url.txt temp_repo
          echo "ğŸ§¹ å·¥ä½œåŒºå·²æ¸…ç†"
