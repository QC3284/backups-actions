name: Repository Backup and Release with Disk Management

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * *'

permissions:
  contents: write

jobs:
  backup-and-release:
    runs-on: ubuntu-latest
    steps:
      - name: Free Disk Space
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: true
          target-free-space: 10GB

      - name: Setup environment
        run: |
          mkdir -p backup_temp compressed_backups
          touch success_backups.txt failed_backups.txt uploaded_backups.txt

      - name: Install required tools
        run: sudo apt-get install -y zstd pv jq

      - name: Generate release tag
        id: release_tag
        run: |
          TAG_NAME="backup-$(date +%Y%m%d%H%M%S)"
          echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "release_title=ğŸ“¦ Repository Backups $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_OUTPUT

      - name: Create draft release
        id: create_release
        run: |
          gh release create "${{ steps.release_tag.outputs.tag_name }}" \
            --title "${{ steps.release_tag.outputs.release_title }}" \
            --notes "ğŸš§ Backup in progress..." \
            --draft
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Backup and compress repositories
        id: backup
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # ç£ç›˜ç©ºé—´é˜ˆå€¼ï¼ˆMBï¼‰
          DISK_THRESHOLD=500
          
          # è·å–å½“å‰ç£ç›˜å¯ç”¨ç©ºé—´
          get_disk_space() {
            df -BM . | awk 'NR==2 {print $4}' | sed 's/M//'
          }
          
          # ä¸Šä¼ å¤‡ä»½æ–‡ä»¶å‡½æ•°
          upload_backup() {
            local file=$1
            local repo_info=$2
            
            echo "ğŸ“¤ Uploading $file"
            if gh release upload "${{ steps.release_tag.outputs.tag_name }}" "$file" \
                 --repo $GITHUB_REPOSITORY \
                 --clobber; then
              echo "âœ… Upload success"
              echo "$repo_info $(du -h "$file" | cut -f1)" >> uploaded_backups.txt
              rm -f "$file"
              return 0
            else
              echo "âŒ Upload failed"
              return 1
            fi
          }
          
          # å¤„ç†æ¯ä¸ªä»“åº“URL
          while IFS= read -r repo_url; do
            [[ -z "$repo_url" || "$repo_url" == \#* ]] && continue
            echo "ğŸ“¦ Processing: $repo_url"
            
            if [[ $repo_url =~ github.com[/:]([^/]+)/([^/.]+) ]]; then
              owner="${BASH_REMATCH[1]}"
              repo="${BASH_REMATCH[2]%.git}"
              backup_dir="backup_temp/$owner-$repo"
              compressed_file="compressed_backups/$owner-$repo-$(date +%Y%m%d%H%M%S).tar.zst"
              
              # æ£€æŸ¥ç£ç›˜ç©ºé—´
              disk_space=$(get_disk_space)
              echo "ğŸ’½ Disk space: ${disk_space}MB (threshold: ${DISK_THRESHOLD}MB)"
              
              # ç©ºé—´ä¸è¶³æ—¶ä¸Šä¼ ç°æœ‰å¤‡ä»½
              if [ "$disk_space" -lt "$DISK_THRESHOLD" ]; then
                echo "âš ï¸ Low disk space! Uploading pending backups..."
                for file in compressed_backups/*.tar.zst; do
                  [ -f "$file" ] && upload_backup "$file" "$(basename "$file" | cut -d'-' -f1,2)"
                done
                disk_space=$(get_disk_space)
              fi
              
              # å¤‡ä»½é€»è¾‘
              status=1
              for ((retry=1; retry<=3; retry++)); do
                echo "ğŸ”„ Cloning (attempt $retry/3)"
                rm -rf "$backup_dir" 2>/dev/null || true
                git clone --mirror "$repo_url" "$backup_dir" 2>&1 | sed 's/^/    /'
                status=$?
                
                if [ $status -eq 0 ]; then
                  repo_size=$(du -sm "$backup_dir" | cut -f1)
                  echo "âœ… Cloned ($repo_size MB)"
                  
                  # å‹ç¼©ä½¿ç”¨zstdæœ€é«˜çº§åˆ«
                  echo "ğŸ’¾ Compressing with zstd ultra (level 22)"
                  mkdir -p "$(dirname "$compressed_file")"
                  
                  (
                    cd "$backup_dir"
                    tar cf - . | pv -s "$(du -sb . | cut -f1)" | zstd -22 --ultra -T0 > "$GITHUB_WORKSPACE/$compressed_file"
                  )
                  
                  if [ -f "$compressed_file" ]; then
                    file_size=$(du -h "$compressed_file" | cut -f1)
                    echo "ğŸ“¦ Compressed: $file_size"
                    echo "$owner/$repo" >> success_backups.txt
                    
                    # å¤§æ–‡ä»¶ç«‹å³ä¸Šä¼ 
                    file_size_mb=$(du -m "$compressed_file" | cut -f1)
                    [ "$file_size_mb" -gt 50 ] && upload_backup "$compressed_file" "$owner/$repo"
                  else
                    echo "âŒ Compression failed"
                    status=1
                  fi
                  break
                else
                  echo "âš ï¸ Clone failed"
                  [ $retry -lt 3 ] && sleep 5
                fi
              done
              
              [ $status -ne 0 ] && echo "$owner/$repo" >> failed_backups.txt
              rm -rf "$backup_dir"
            else
              echo "âš ï¸ Invalid URL: $repo_url" >> failed_backups.txt
            fi
            echo "--------------------------------------------------"
          done < back_ck_url.txt

      - name: Upload remaining backups
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          for file in compressed_backups/*.tar.zst; do
            [ -f "$file" ] && gh release upload "${{ steps.release_tag.outputs.tag_name }}" "$file" \
              --repo $GITHUB_REPOSITORY \
              --clobber && rm -f "$file"
          done

      - name: Generate Release Summary
        id: release_summary
        run: |
          success_count=$(wc -l < success_backups.txt 2>/dev/null || echo 0)
          failed_count=$(wc -l < failed_backups.txt 2>/dev/null || echo 0)
          low_disk_count=$(grep -c "Low disk space" $GITHUB_STEP_SUMMARY 2>/dev/null || echo 0)
          
          # æ„å»ºæŠ¥å‘Š
          release_body="## ğŸ“Š Backup Summary\n\n"
          release_body+="### âœ… Success ($success_count)\n"
          [ -s uploaded_backups.txt ] && release_body+="$(awk '{print "| " $1 " | " $2 " |"}' uploaded_backups.txt)\n"
          
          release_body+="\n### âŒ Failed ($failed_count)\n"
          [ -s failed_backups.txt ] && release_body+="$(awk '{print "| " $0 " | Backup failed |"}' failed_backups.txt)\n" || release_body+="| - | All succeeded |\n"
          
          release_body+="\n### ğŸ’¾ Disk\n- Cleanup performed\n- Low space detected $low_disk_count times"
          
          # è®¾ç½®è¾“å‡ºå˜é‡
          echo "success_count=$success_count" >> $GITHUB_OUTPUT
          echo "failed_count=$failed_count" >> $GITHUB_OUTPUT
          
          # ç¼–ç è¾“å‡º
          release_body="${release_body//'%'/'%25'}"
          release_body="${release_body//$'\n'/'%0A'}"
          echo "release_body=$release_body" >> $GITHUB_OUTPUT

      - name: Finalize release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # è§£ç å¹¶å‘å¸ƒ
          release_body="${RELEASE_BODY//'%0A'/$'\n'}"
          release_body="${release_body//'%25'/'%'}"
          
          gh release edit "${{ steps.release_tag.outputs.tag_name }}" \
            --title "${{ steps.release_tag.outputs.release_title }}" \
            --notes "$release_body" \
            --draft=false

      - name: Report status
        run: |
          echo "## ğŸ“Š Backup Summary" >> $GITHUB_STEP_SUMMARY
          echo "### âœ… Success: ${{ steps.release_summary.outputs.success_count }}" >> $GITHUB_STEP_SUMMARY
          [ -f uploaded_backups.txt ] && awk '{print "| " $1 " | " $2 " |"}' uploaded_backups.txt >> $GITHUB_STEP_SUMMARY
          
          echo "### âŒ Failed: ${{ steps.release_summary.outputs.failed_count }}" >> $GITHUB_STEP_SUMMARY
          [ -f failed_backups.txt ] && awk '{print "| " $0 " |"}' failed_backups.txt >> $GITHUB_STEP_SUMMARY || echo "| All succeeded |" >> $GITHUB_STEP_SUMMARY
          
          release_url="https://github.com/$GITHUB_REPOSITORY/releases/tag/${{ steps.release_tag.outputs.tag_name }}"
          echo "### ğŸ“¦ Release: [View]($release_url)" >> $GITHUB_STEP_SUMMARY
