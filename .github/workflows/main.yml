name: Repository Backup and Release with Disk Management

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * *'

permissions:
  contents: write

jobs:
  backup-and-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout current repo
        uses: actions/checkout@v4

      - name: Free Disk Space
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: true
          android-sdk-cache: true
          dotnet-sdk-cache: true
          haskell-stack-cache: true
          pip-cache: true
          ruby-bundle-cache: true
          swap-storage: true
          target-free-space: 10GB

      - name: Setup environment
        run: |
          mkdir -p backup_temp
          mkdir -p compressed_backups
          echo "" > success_backups.txt
          echo "" > failed_backups.txt
          echo "" > uploaded_backups.txt
          echo "" > pending_backups.txt

      - name: Install required tools
        run: |
          sudo apt-get update
          sudo apt-get install -y xz-utils bc pv jq

      - name: Generate release tag
        id: release_tag
        run: |
          TAG_NAME="backup-$(date +%Y%m%d%H%M%S)"
          echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "release_title=üì¶ Repository Backups $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_OUTPUT

      - name: Create draft release
        id: create_release
        run: |
          gh release create "${{ steps.release_tag.outputs.tag_name }}" \
            --title "${{ steps.release_tag.outputs.release_title }}" \
            --notes "üöß Backup in progress..." \
            --draft
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Backup and compress repositories with disk management
        id: backup
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}  # Ê∑ªÂä†ÁéØÂ¢ÉÂèòÈáè
        run: |
          # Á£ÅÁõòÁ©∫Èó¥ÈòàÂÄºÔºàMBÔºâ
          DISK_THRESHOLD=500
          
          # Ëé∑ÂèñÂΩìÂâçÁ£ÅÁõòÂèØÁî®Á©∫Èó¥ÔºàMBÔºâ
          get_disk_space() {
            df -BM . | awk 'NR==2 {print $4}' | sed 's/M//'
          }
          
          # ‰∏ä‰º†Â§á‰ªΩÊñá‰ª∂ÂáΩÊï∞
          upload_backup() {
            local file=$1
            local repo_info=$2
            
            echo "üì§ Uploading $file"
            if gh release upload "${{ steps.release_tag.outputs.tag_name }}" "$file" \
                 --repo $GITHUB_REPOSITORY \
                 --clobber; then
              echo "‚úÖ Upload success"
              echo "$repo_info $(du -h "$file" | cut -f1)" >> uploaded_backups.txt
              rm -f "$file"
              return 0
            else
              echo "‚ùå Upload failed"
              return 1
            fi
          }
          
          # Â§ÑÁêÜÊØè‰∏™‰ªìÂ∫ìURL
          while IFS= read -r repo_url; do
            [[ -z "$repo_url" || "$repo_url" == \#* ]] && continue
            echo "üì¶ Processing: $repo_url"
            
            if [[ $repo_url =~ github.com[/:]([^/]+)/([^/.]+) ]]; then
              owner="${BASH_REMATCH[1]}"
              repo="${BASH_REMATCH[2]%.git}"
              backup_dir="backup_temp/$owner-$repo"
              compressed_file="compressed_backups/$owner-$repo-$(date +%Y%m%d%H%M%S).tar.xz"
              
              # Ê£ÄÊü•Á£ÅÁõòÁ©∫Èó¥
              disk_space=$(get_disk_space)
              echo "üíΩ Current disk space: ${disk_space}MB (threshold: ${DISK_THRESHOLD}MB)"
              
              # Â¶ÇÊûúÁ£ÅÁõòÁ©∫Èó¥‰∏çË∂≥Ôºå‰∏ä‰º†ÈÉ®ÂàÜÂ§á‰ªΩ
              if [ "$disk_space" -lt "$DISK_THRESHOLD" ]; then
                echo "‚ö†Ô∏è Low disk space! Uploading pending backups..."
                
                # ‰∏ä‰º†ÊâÄÊúâÂæÖÂ§ÑÁêÜÂ§á‰ªΩ
                for file in compressed_backups/*.tar.xz; do
                  if [ -f "$file" ]; then
                    repo_name=$(basename "$file" | cut -d'-' -f1,2)
                    upload_backup "$file" "$repo_name"
                  fi
                done
                
                # ÂÜçÊ¨°Ê£ÄÊü•Á£ÅÁõòÁ©∫Èó¥
                disk_space=$(get_disk_space)
                echo "üíΩ Freed space. Now: ${disk_space}MB"
              fi
              
              status=1
              retry_count=0
              max_retries=3
              
              while [ $status -ne 0 ] && [ $retry_count -lt $max_retries ]; do
                echo "üîÑ Cloning repository (attempt $((retry_count+1))"
                rm -rf "$backup_dir" 2>/dev/null || true
                
                # ÂÖãÈöÜ‰ªìÂ∫ìÔºàÈôêÂà∂Ê∑±Â∫¶‰ª•ËäÇÁúÅÁ©∫Èó¥Ôºâ
                git clone --mirror --depth 1 "$repo_url" "$backup_dir" 2>&1 | sed 's/^/    /'
                status=$?
                
                if [ $status -eq 0 ]; then
                  echo "‚úÖ Clone success"
                  
                  # Ëé∑Âèñ‰ªìÂ∫ìÂ§ßÂ∞èÔºàMBÔºâ
                  repo_size=$(du -sm "$backup_dir" | cut -f1)
                  echo "üìä Repository size: ${repo_size}MB"
                  
                  # Ê£ÄÊü•ÊòØÂê¶ÊúâË∂≥Â§üÁ©∫Èó¥ËøõË°åÂéãÁº©Ôºà‰º∞ÁÆóÂéãÁº©ÂêéÂ§ßÂ∞èÔºâ
                  estimated_compressed_size=$((repo_size / 2))
                  if [ "$disk_space" -lt "$estimated_compressed_size" ]; then
                    echo "‚ö†Ô∏è Not enough space for compression (needed ~${estimated_compressed_size}MB)"
                    
                    # Â∞ùËØï‰∏ä‰º†Áé∞ÊúâÂ§á‰ªΩÈáäÊîæÁ©∫Èó¥
                    for file in compressed_backups/*.tar.xz; do
                      if [ -f "$file" ]; then
                        repo_name=$(basename "$file" | cut -d'-' -f1,2)
                        upload_backup "$file" "$repo_name"
                      fi
                    done
                    
                    # ÂÜçÊ¨°Ê£ÄÊü•Á©∫Èó¥
                    disk_space=$(get_disk_space)
                    if [ "$disk_space" -lt "$estimated_compressed_size" ]; then
                      echo "‚ùå Still not enough space after cleanup. Skipping..."
                      echo "$owner/$repo" >> failed_backups.txt
                      status=1
                      break
                    fi
                  fi
                  
                  # ÂéãÁº©‰ªìÂ∫ì
                  echo "üíæ Compressing with maximum compression"
                  mkdir -p "$(dirname "$compressed_file")"
                  
                  (
                    cd "$backup_dir"
                    tar cf - . | pv -s "$(du -sb . | cut -f1)" | xz -9e -T0 > "$GITHUB_WORKSPACE/$compressed_file"
                  )
                  
                  # Ê£ÄÊü•ÂéãÁº©ÁªìÊûú
                  if [ -f "$compressed_file" ]; then
                    file_size=$(du -h "$compressed_file" | cut -f1)
                    echo "üì¶ Created compressed backup: $compressed_file ($file_size)"
                    echo "$owner/$repo" >> success_backups.txt
                    echo "$owner/$repo $file_size" >> pending_backups.txt
                    
                    # Á´ãÂç≥‰∏ä‰º†Â§ßÊñá‰ª∂Ôºà>50MBÔºâ
                    file_size_mb=$(du -m "$compressed_file" | cut -f1)
                    if [ "$file_size_mb" -gt 50 ]; then
                      echo "üöÄ Uploading large file immediately (>50MB)"
                      if upload_backup "$compressed_file" "$owner/$repo"; then
                        # ‰ªéÂæÖÂ§ÑÁêÜÂàóË°®‰∏≠ÁßªÈô§
                        sed -i "/$owner\/repo/d" pending_backups.txt
                      fi
                    fi
                    
                    break
                  else
                    echo "‚ùå Compression failed: file not created"
                    status=1
                  fi
                else
                  echo "‚ö†Ô∏è Attempt $((retry_count+1)) failed"
                  retry_count=$((retry_count+1))
                  if [ $retry_count -lt $max_retries ]; then
                    echo "‚è≥ Waiting 5 seconds before retry"
                    sleep 5
                  fi
                fi
              done
              
              if [ $status -ne 0 ]; then
                echo "‚ùå Backup failed after $max_retries attempts"
                echo "$owner/$repo" >> failed_backups.txt
              fi
              
              rm -rf "$backup_dir" 2>/dev/null || true
            else
              echo "‚ö†Ô∏è Invalid URL: $repo_url"
              echo "$repo_url (invalid)" >> failed_backups.txt
            fi
            echo "--------------------------------------------------"
          done < back_ck_url.txt

      - name: Upload remaining backups
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}  # Ê∑ªÂä†ÁéØÂ¢ÉÂèòÈáè
        run: |
          # ‰∏ä‰º†ÊâÄÊúâÂâ©‰ΩôÁöÑÂ§á‰ªΩÊñá‰ª∂
          for file in compressed_backups/*.tar.xz; do
            if [ -f "$file" ]; then
              repo_name=$(basename "$file" | cut -d'-' -f1,2)
              echo "üì§ Uploading $file"
              if gh release upload "${{ steps.release_tag.outputs.tag_name }}" "$file" \
                   --repo $GITHUB_REPOSITORY \
                   --clobber; then
                echo "‚úÖ Upload success"
                echo "$repo_name $(du -h "$file" | cut -f1)" >> uploaded_backups.txt
                rm -f "$file"
              else
                echo "‚ùå Upload failed"
              fi
            fi
          done

      - name: Generate Release Summary
        id: release_summary
        run: |
          success_count=$(grep -c . success_backups.txt 2>/dev/null || echo 0)
          failed_count=$(grep -c . failed_backups.txt 2>/dev/null || echo 0)
          
          release_body="## üìä Backup Summary\n\n"
          release_body+="### ‚úÖ Successfully Backed Up ($success_count)\n"
          release_body+="| Repository | Size |\n"
          release_body+="|------------|------|\n"
          
          # ‰ªé‰∏ä‰º†ËÆ∞ÂΩï‰∏≠Ëé∑ÂèñÂ§ßÂ∞è‰ø°ÊÅØ
          if [ -f uploaded_backups.txt ]; then
            while IFS= read -r line; do
              if [ -n "$line" ]; then
                repo=$(echo "$line" | awk '{print $1}')
                size=$(echo "$line" | awk '{print $2}')
                release_body+="| $repo | $size |\n"
              fi
            done < uploaded_backups.txt
          fi
          
          release_body+="\n### ‚ùå Failed to Backup ($failed_count)\n"
          release_body+="| Repository | Reason |\n"
          release_body+="|------------|--------|\n"
          
          if [ -s failed_backups.txt ]; then
            while IFS= read -r repo; do
              if [ -n "$repo" ]; then
                if [[ "$repo" == *"(invalid)" ]]; then
                  release_body+="| ${repo% (invalid)} | Invalid URL |\n"
                else
                  release_body+="| $repo | Backup failed |\n"
                fi
              fi
            done < failed_backups.txt
          else
            release_body+="| - | All backups succeeded |\n"
          fi
          
          release_body+="\n### üíæ Disk Space Management\n"
          release_body+="- Initial disk cleanup performed\n"
          release_body+="- Low disk space detected $(grep -c "Low disk space" $GITHUB_STEP_SUMMARY || echo 0) times\n"
          release_body+="- Large files (>50MB) uploaded immediately\n"
          
          echo "success_count=$success_count" >> $GITHUB_OUTPUT
          echo "failed_count=$failed_count" >> $GITHUB_OUTPUT
          echo "release_body<<EOF" >> $GITHUB_OUTPUT
          echo -e "$release_body" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Finalize release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}  # Ê∑ªÂä†ÁéØÂ¢ÉÂèòÈáè
        run: |
          # Êõ¥Êñ∞releaseÊ†áÈ¢òÂíåÊèèËø∞
          gh release edit "${{ steps.release_tag.outputs.tag_name }}" \
            --title "${{ steps.release_tag.outputs.release_title }}" \
            --notes "${{ steps.release_summary.outputs.release_body }}"
          
          # ÂèëÂ∏ÉreleaseÔºàÂèñÊ∂àËçâÁ®øÁä∂ÊÄÅÔºâ
          gh release edit "${{ steps.release_tag.outputs.tag_name }}" --draft=false

      - name: Report status
        run: |
          echo "## üìä Backup Summary" >> $GITHUB_STEP_SUMMARY
          echo "### ‚úÖ Successfully Backed Up (${{ steps.release_summary.outputs.success_count }})" >> $GITHUB_STEP_SUMMARY
          echo "| Repository | Size |" >> $GITHUB_STEP_SUMMARY
          echo "|------------|------|" >> $GITHUB_STEP_SUMMARY
          
          if [ -f uploaded_backups.txt ]; then
            while IFS= read -r line; do
              if [ -n "$line" ]; then
                repo=$(echo "$line" | awk '{print $1}')
                size=$(echo "$line" | awk '{print $2}')
                echo "| $repo | $size |" >> $GITHUB_STEP_SUMMARY
              fi
            done < uploaded_backups.txt
          fi
          
          echo "### ‚ùå Failed to Backup (${{ steps.release_summary.outputs.failed_count }})" >> $GITHUB_STEP_SUMMARY
          echo "| Repository | Reason |" >> $GITHUB_STEP_SUMMARY
          echo "|------------|--------|" >> $GITHUB_STEP_SUMMARY
          
          if [ -s failed_backups.txt ]; then
            while IFS= read -r repo; do
              if [ -n "$repo" ]; then
                if [[ "$repo" == *"(invalid)" ]]; then
                  echo "| ${repo% (invalid)} | Invalid URL |" >> $GITHUB_STEP_SUMMARY
                else
                  echo "| $repo | Backup failed |" >> $GITHUB_STEP_SUMMARY
                fi
              fi
            done < failed_backups.txt
          else
            echo "| - | All backups succeeded |" >> $GITHUB_STEP_SUMMARY
          fi
          
          release_url="https://github.com/$GITHUB_REPOSITORY/releases/tag/${{ steps.release_tag.outputs.tag_name }}"
          echo "### üì¶ Release Created" >> $GITHUB_STEP_SUMMARY
          echo "[View Release]($release_url)" >> $GITHUB_STEP_SUMMARY
          echo "### üíæ Disk Space Usage" >> $GITHUB_STEP_SUMMARY
          echo "```" >> $GITHUB_STEP_SUMMARY
          df -h . >> $GITHUB_STEP_SUMMARY
          echo "```" >> $GITHUB_STEP_SUMMARY
